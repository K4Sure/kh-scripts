#!/usr/bin/env bash
# ==============================================
# FILE: ~/kh-scripts/library/colors/cml-test.sh
# CML General Test Harness (Merged Edition) - FIXED
# Version: v4.5.0
# ==============================================

CML_DIR="$HOME/kh-scripts/library/colors"
ENGINE_FILE="$CML_DIR/cml-truecolor.sh"
THEME_FILE="$CML_DIR/.cml_theme"
BACKUP_DIR="$HOME/kh-scripts/backup"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
CML_VERSION="v4.5.0"

# Ensure backup dir exists and backup current test file if present
if [ -f "$CML_DIR/cml-test.sh" ]; then
  mkdir -p "$BACKUP_DIR"
  cp "$CML_DIR/cml-test.sh" "$BACKUP_DIR/cml-test_${TIMESTAMP}.bak"
  echo "‚úî BACKUP SAVED: $BACKUP_DIR/cml-test_${TIMESTAMP}.bak"
fi

# Source the TrueColor engine (single source of truth)
if [ -f "$ENGINE_FILE" ]; then
  # shellcheck disable=SC1090
  source "$ENGINE_FILE"
else
  echo "‚ùå MISSING ENGINE: $ENGINE_FILE"
  exit 1
fi

# ----------------------------------------------
# HEADER
# ----------------------------------------------
echo
echo "=== üß™ COLOR MASTER LIBRARY GENERAL TEST ==="
echo "CML VERSION: $CML_VERSION"
echo "TRUECOLOR ENGINE: ${CML_TRUECOLOR_VERSION:-UNKNOWN}"
echo "TEST STARTED: $(date)"
echo

# ----------------------------------------------
# THEME READ STANDARD (exactly as required)
# ----------------------------------------------
if [ -f "$THEME_FILE" ]; then
  CURRENT_THEME=$(< "$THEME_FILE")
  CURRENT_THEME="${CURRENT_THEME//[$'\r\n']/}"
  CURRENT_THEME="${CURRENT_THEME^^}"
else
  CURRENT_THEME=""
fi

# AUTO-DEFAULT THEME if empty (write using THEME WRITE STANDARD)
if [ -z "$CURRENT_THEME" ]; then
  echo "‚ö† THEME EMPTY ‚Äî APPLYING AUTO-DEFAULT"
  UTHEME="CLASSIC"
  UTHEME="${UTHEME^^}"
  UTHEME="${UTHEME//[$'\r\n' ]/}"
  printf "%s" "$UTHEME" > "$THEME_FILE"
  sync
  CURRENT_THEME="$UTHEME"
fi

# ----------------------------------------------
# ENGINE INTEGRITY TEST
# ----------------------------------------------
echo "[1] ENGINE INTEGRITY TEST"
if declare -F rgb_fg >/dev/null && declare -F rgb_bg >/dev/null && declare -F hex_to_rgb >/dev/null; then
  echo "‚úî ENGINE FUNCTIONS DETECTED"
else
  echo "‚ùå ENGINE FUNCTIONS MISSING"
  exit 1
fi

if cml_truecolor_supported; then
  echo "‚úî TRUECOLOR SUPPORT DETECTED"
else
  echo "‚ö† TRUECOLOR NOT SUPPORTED ‚Äî FALLBACK ACTIVE"
fi
echo

# ----------------------------------------------
# THEME FILE VALIDATION (report)
# ----------------------------------------------
echo "[2] THEME FILE VALIDATION"
echo "‚úî ACTIVE THEME: $CURRENT_THEME"
echo

# ----------------------------------------------
# RGB / HEX / FALLBACK TESTS (robust printing)
# ----------------------------------------------
echo "[3] RGB / HEX / FALLBACK TESTS"
echo "Testing rgb_fg / rgb_bg with gradients..."
# Use printf %b so returned escape sequences are interpreted
printf "%b\n" "$(rgb_bg 0 0 255)$(rgb_fg 255 255 255) GRADIENT DEMO ${C_RESET:-\\033[0m}"

# show some background samples in one line (explicit reset each)
for i in 0 64 128 192 255; do
  printf "%b" "$(rgb_bg $i 0 128)  %3d  ${C_RESET:-\\033[0m}" "$i"
done
printf "\n"

# HEX -> RGB
HEX_RESULT=$(hex_to_rgb "#1E90FF" 2>/dev/null || true)
if [ -n "$HEX_RESULT" ]; then
  echo "HEX ‚Üí RGB (#1E90FF): $HEX_RESULT"
else
  echo "HEX ‚Üí RGB (#1E90FF): (no result)"
fi

# Fallback color check (explicit)
FALLBACK3=$(cml_fallback_color 3 2>/dev/null || true)
if [ -z "$FALLBACK3" ]; then
  echo "Fallback color [3]: (empty)"
else
  echo "Fallback color [3]: $FALLBACK3"
fi
echo

# ----------------------------------------------
# PALETTE LOAD TEST
# ----------------------------------------------
echo "[4] PALETTE LOAD TEST"
if cml_load_palette "$CURRENT_THEME"; then
  echo "‚úî PALETTE LOADED FOR: $CURRENT_THEME"
else
  echo "‚ùå PALETTE LOAD FAILED FOR: $CURRENT_THEME"
fi
echo

# Ensure common color/reset vars exist after palette load
: "${C_RESET:=${C_RESET:-\\033[0m}}"

# ----------------------------------------------
# COLORIZE & TITLE TEST (use printf %b to render)
# ----------------------------------------------
echo "[5] COLORIZE & TITLE TEST"
# Title (engine may return sequences)
if declare -F cml_title >/dev/null; then
  printf "%b\n" "$(cml_title "CML COLORIZED TITLE SAMPLE")"
else
  printf "%b\n" "${C_SYMBOL:-} CML COLORIZED TITLE SAMPLE ${C_RESET}"
fi

# Safe prints for colorized lines; fall back gracefully if variables missing
if declare -F cml_colorize >/dev/null; then
  printf "%b\n" "$(cml_colorize "INFO LINE" "${C_INFO:-}")"
  printf "%b\n" "$(cml_colorize "SUCCESS LINE" "${C_GOOD:-}")"
  printf "%b\n" "$(cml_colorize "ERROR LINE" "${C_BAD:-}")"
  printf "%b\n" "$(cml_colorize "SYMBOL TEST" "${C_SYMBOL:-}")"
else
  echo "INFO LINE"
  echo "SUCCESS LINE"
  echo "ERROR LINE"
  echo "SYMBOL TEST"
fi
# Ensure reset
printf "%b\n" "${C_RESET}"
echo

# ----------------------------------------------
# THEME VISUAL DEMO
# ----------------------------------------------
echo "[6] THEME VISUAL DEMO"
# Print named samples using available palette variables
for label in TITLE INFO GOOD WARN BAD SYMBOL; do
  var="C_${label}"
  # Use cml_colorize if available, else attempt to print raw variable prefix
  if declare -F cml_colorize >/dev/null; then
    printf "%b\n" "$(cml_colorize "Sample ${label}" "${!var:-}")"
  else
    echo "Sample ${label}"
  fi
done

# Final reset and demo finished message
printf "%b\n" "${C_RESET}"
echo "‚úî DEMO FINISHED. ACTIVE THEME: $CURRENT_THEME"
echo

# ----------------------------------------------
# SUMMARY
# ----------------------------------------------
echo "=============================================="
echo "‚úî CML GENERAL TEST HARNESS FINISHED."
echo "RUN DATE: $(date)"
echo "=============================================="
echo

exit 0
