#!/usr/bin/env bash
# ==============================================
# FILE: ~/kh-scripts/library/colors/cml-test.sh
# CML General Test Harness (Merged Edition)
# Combines CML Core Test + TrueColor Engine Test
# Version: v4.5.0
# ==============================================

# Directories and constants
CML_DIR="$HOME/kh-scripts/library/colors"
ENGINE_FILE="$CML_DIR/cml-truecolor.sh"
THEME_FILE="$CML_DIR/.cml_theme"
BACKUP_DIR="$HOME/kh-scripts/backup"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# Backup before overwrite safeguard
if [ -f "$CML_DIR/cml-test.sh" ]; then
  mkdir -p "$BACKUP_DIR"
  cp "$CML_DIR/cml-test.sh" "$BACKUP_DIR/cml-test_${TIMESTAMP}.bak"
  echo "‚úî BACKUP SAVED: $BACKUP_DIR/cml-test_${TIMESTAMP}.bak"
fi

# Load engine
if [ -f "$ENGINE_FILE" ]; then
  source "$ENGINE_FILE"
else
  echo "‚ùå MISSING ENGINE: $ENGINE_FILE"
  exit 1
fi

# ----------------------------------------------
# SECTION 1: HEADER
# ----------------------------------------------
echo
echo "=== üß™ COLOR MASTER LIBRARY GENERAL TEST ==="
echo "CML VERSION: v4.5.0"
echo "TRUECOLOR ENGINE: ${CML_TRUECOLOR_VERSION:-UNKNOWN}"
echo "TEST STARTED: $(date)"
echo

# ----------------------------------------------
# SECTION 2: TRUECOLOR ENGINE CHECK
# ----------------------------------------------
echo "[1] ENGINE INTEGRITY TEST"
if declare -F rgb_fg >/dev/null && declare -F rgb_bg >/dev/null; then
  echo "‚úî ENGINE FUNCTIONS DETECTED"
else
  echo "‚ùå ENGINE FUNCTIONS MISSING"
  exit 1
fi

if cml_truecolor_supported; then
  echo "‚úî TRUECOLOR SUPPORT DETECTED"
else
  echo "‚ö† TRUECOLOR NOT SUPPORTED ‚Äî FALLBACK ACTIVE"
fi
echo

# ----------------------------------------------
# SECTION 3: THEME FILE & AUTO-DEFAULT
# ----------------------------------------------
echo "[2] THEME FILE VALIDATION"
if [ -f "$THEME_FILE" ]; then
  CURRENT_THEME=$(< "$THEME_FILE")
  CURRENT_THEME="${CURRENT_THEME//[$'\r\n']/}"
  CURRENT_THEME="${CURRENT_THEME^^}"
else
  CURRENT_THEME=""
fi

if [ -z "$CURRENT_THEME" ]; then
  echo "‚ö† THEME EMPTY ‚Äî APPLYING AUTO-DEFAULT"
  printf "%s" "CLASSIC" > "$THEME_FILE"
  sync
  CURRENT_THEME="CLASSIC"
fi
echo "‚úî ACTIVE THEME: $CURRENT_THEME"
echo

# ----------------------------------------------
# SECTION 4: RGB / HEX / FALLBACK TESTS
# ----------------------------------------------
echo "[3] RGB / HEX / FALLBACK TESTS"
echo "Testing rgb_fg / rgb_bg with gradients..."
printf "%s GRADIENT DEMO %s\n" "$(rgb_bg 0 0 255)$(rgb_fg 255 255 255)" "$(printf '\033[0m')"
for i in 0 64 128 192 255; do
  printf "%s %3d %s" "$(rgb_bg $i 0 128)" "$i" "$(printf '\033[0m')"
done
echo
RGB_RESULT=$(hex_to_rgb "#1E90FF")
echo "HEX ‚Üí RGB (#1E90FF): $RGB_RESULT"
echo "Fallback color [3]: $(cml_fallback_color 3)"
echo

# ----------------------------------------------
# SECTION 5: THEME PALETTE LOAD
# ----------------------------------------------
echo "[4] PALETTE LOAD TEST"
if cml_load_palette "$CURRENT_THEME"; then
  echo "‚úî PALETTE LOADED FOR: $CURRENT_THEME"
else
  echo "‚ùå PALETTE LOAD FAILED FOR: $CURRENT_THEME"
fi
echo

# ----------------------------------------------
# SECTION 6: COLORIZED OUTPUT TEST
# ----------------------------------------------
echo "[5] COLORIZE & TITLE TEST"
cml_title "CML COLORIZED TITLE SAMPLE"
echo "$(cml_colorize "INFO LINE" "$C_INFO")"
echo "$(cml_colorize "SUCCESS LINE" "$C_GOOD")"
echo "$(cml_colorize "ERROR LINE" "$C_BAD")"
echo "$(cml_colorize "SYMBOL TEST" "$C_SYMBOL")"
echo

# ----------------------------------------------
# SECTION 7: DEMO DISPLAY
# ----------------------------------------------
echo "[6] THEME VISUAL DEMO"
for t in TITLE INFO GOOD WARN BAD SYMBOL; do
  var="C_${t}"
  echo "$(cml_colorize "Sample $t" "${!var}")"
done
printf "%s\n" "$C_RESET"
echo "‚úî DEMO FINISHED. ACTIVE THEME: $CURRENT_THEME"
echo

# ----------------------------------------------
# SECTION 8: SUMMARY
# ----------------------------------------------
echo "=============================================="
echo "‚úî CML GENERAL TEST HARNESS COMPLETED SUCCESSFULLY"
echo "RUN DATE: $(date)"
echo "=============================================="
echo

exit 0
