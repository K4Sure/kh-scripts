#!/usr/bin/env bash
# File: ~/kh-scripts/library/colors/cml-theme.sh
# CML Theme Manager v4.3.0  <- all-uppercase enforced

CML_DIR="$HOME/kh-scripts/library/colors"
THEME_FILE="$CML_DIR/.cml_theme"

# Ensure directory + theme file exist
mkdir -p "$CML_DIR"
[ -f "$THEME_FILE" ] || echo "CLASSIC" > "$THEME_FILE"

# Read current theme, trim and force uppercase
read_current_theme() {
  CURRENT_THEME=$(< "$THEME_FILE")
  CURRENT_THEME="${CURRENT_THEME//[$'\r\n']/}"
  CURRENT_THEME="${CURRENT_THEME^^}"
}

# Helper: write theme (always uppercase), confirm, then exit
confirm_and_exit() {
  local msg="$1"
  echo "$msg" | tr '[:lower:]' '[:upper:]' > "$THEME_FILE"
  echo
  echo "✔ THEME SET TO: $msg"
  sleep 1
  clear
  exit 0
}

# Draw main menu
draw_main_menu() {
  clear
  echo "=== CML v4.3.0 → THEME SELECTION ==="
  echo
  local i=1
  for theme in CLASSIC NEON FOREST DESERT OCEAN SUMMER WINTER WILD; do
    mark=""
    arrow=""

    if [[ "$CURRENT_THEME" == "$theme" ]] || [[ "$CURRENT_THEME" == NEON:* && "$theme" == "NEON" ]]; then
      mark="  ✔"
    fi
    if [[ "$theme" == "NEON" ]]; then
      arrow="  >"
    fi

    printf "<%d>  %s%s%s\n" "$i" "$theme" "$mark" "$arrow"
    i=$((i+1))
  done

  echo
  echo "• ✔ = CURRENT THEME"
  echo "• > = CHOOSE COLOR"
  echo "• PRESS ESC TO EXIT."
  echo
  echo -n "• THEME SELECTION: "
}

# Draw neon submenu
draw_neon_menu() {
  clear
  echo "=== CML v4.3.0 → NEON THEME BASE COLOR SELECTION ==="
  echo
  local colors=(RED ORANGE YELLOW GREEN BLUE PURPLE)
  local i=1
  for c in "${colors[@]}"; do
    mark=""
    if [[ "$CURRENT_THEME" == "NEON:$c" ]]; then
      mark="  ✔"
    fi
    printf "<%d>  %s%s\n" "$i" "$c" "$mark"
    i=$((i+1))
  done
  echo
  echo "• ✔ = CURRENT COLOR"
  echo "• PRESS ESC TO GO BACK."
  echo
  echo -n "• NEON BASE COLOR SELECTION: "
}

# Main loop
while true; do
  read_current_theme
  draw_main_menu
  IFS= read -rsn1 key
  case "$key" in
    $'\e') clear; exit 0 ;;  # ESC from main menu
    1) confirm_and_exit "CLASSIC" ;;
    2) # Neon submenu
       while true; do
         read_current_theme
         draw_neon_menu
         IFS= read -rsn1 nkey
         case "$nkey" in
           $'\e') break ;; # ESC: back to main
           1) confirm_and_exit "NEON:RED" ;;
           2) confirm_and_exit "NEON:ORANGE" ;;
           3) confirm_and_exit "NEON:YELLOW" ;;
           4) confirm_and_exit "NEON:GREEN" ;;
           5) confirm_and_exit "NEON:BLUE" ;;
           6) confirm_and_exit "NEON:PURPLE" ;;
           *) ;; # ignore other keys
         esac
       done
       ;;
    3) confirm_and_exit "FOREST" ;;
    4) confirm_and_exit "DESERT" ;;
    5) confirm_and_exit "OCEAN" ;;
    6) confirm_and_exit "SUMMER" ;;
    7) confirm_and_exit "WINTER" ;;
    8) confirm_and_exit "WILD" ;;
    *) ;; # ignore other keys
  esac
done
