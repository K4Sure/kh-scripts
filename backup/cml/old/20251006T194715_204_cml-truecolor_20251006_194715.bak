#!/usr/bin/env bash
# COLOR MASTER TRUECOLOR ENGINE v1.5.5
# Single-file authoritative color engine (robust + tolerant)

CML_TRUECOLOR_VERSION="v1.5.5"

# -------------------------
# Detect TrueColor support
# -------------------------
cml_truecolor_supported() {
  local ct="${COLORTERM:-}" tm="${TERM:-}"
  ct="${ct,,}"; tm="${tm,,}"
  [[ "$ct" == *truecolor* || "$ct" == *24bit* || "$tm" == *-truecolor* ]]
}

# -------------------------
# Hex <-> RGB helpers
# -------------------------
hex_to_rgb_space() {
  local hex="${1#\#}"
  if [[ ! "$hex" =~ ^[0-9A-Fa-f]{6}$ ]]; then
    printf '255 255 255'
    return
  fi
  printf '%d %d %d' $((16#${hex:0:2})) $((16#${hex:2:2})) $((16#${hex:4:2}))
}

rgb_fg_hex() {
  local r g b; read -r r g b <<< "$(hex_to_rgb_space "$1")"
  printf '\033[38;2;%d;%d;%dm' "$r" "$g" "$b"
}
rgb_bg_hex() {
  local r g b; read -r r g b <<< "$(hex_to_rgb_space "$1")"
  printf '\033[48;2;%d;%d;%dm' "$r" "$g" "$b"
}
cml_reset_color() { printf '\033[0m'; }

# -------------------------
# Palettes: set C_PRIMARY / C_SECONDARY and CURRENT_THEME
# -------------------------
cml_load_palette() {
  local theme="${1:-${CURRENT_THEME:-CLASSIC}}"
  theme="${theme^^}"
  CURRENT_THEME="$theme"
  case "$theme" in
    CLASSIC)      C_PRIMARY="#AAAAAA"; C_SECONDARY="#FFFFFF" ;;
    NEON:RED)     C_PRIMARY="#FF0040"; C_SECONDARY="#FF80A0" ;;
    NEON:ORANGE)  C_PRIMARY="#FF8000"; C_SECONDARY="#FFD080" ;;
    NEON:YELLOW)  C_PRIMARY="#FFF200"; C_SECONDARY="#FFF8B0" ;;
    NEON:GREEN)   C_PRIMARY="#39FF14"; C_SECONDARY="#BFFFC9" ;;
    NEON:BLUE)    C_PRIMARY="#00A0FF"; C_SECONDARY="#80D0FF" ;;
    NEON:PURPLE)  C_PRIMARY="#C000FF"; C_SECONDARY="#E0A0FF" ;;
    FOREST)       C_PRIMARY="#0B6623"; C_SECONDARY="#3CB371" ;;
    DESERT)       C_PRIMARY="#C19A6B"; C_SECONDARY="#F0D8A8" ;;
    OCEAN)        C_PRIMARY="#001F3F"; C_SECONDARY="#00CCFF" ;;
    SUMMER)       C_PRIMARY="#FFCC33"; C_SECONDARY="#99FF66" ;;
    WINTER)       C_PRIMARY="#66B2FF"; C_SECONDARY="#003366" ;;
    WILD)         C_PRIMARY="#FF1493"; C_SECONDARY="#32CD32" ;;
    SUNSET)       C_PRIMARY="#FF4500"; C_SECONDARY="#FFD700" ;;
    MIDNIGHT)     C_PRIMARY="#0B2240"; C_SECONDARY="#2E3A59" ;;
    *)            C_PRIMARY="#AAAAAA"; C_SECONDARY="#FFFFFF" ;;
  esac
}

# -------------------------
# Terminal sizing helper (half width)
# -------------------------
cml_half_width() {
  local cols
  cols=$(tput cols 2>/dev/null || echo 80)
  if [ "$cols" -lt 20 ]; then echo 20; else echo $((cols / 2)); fi
}

# -------------------------
# Render gradient bar or banner text.
# Usage:
#  cml_render_gradient_bar [width] [theme]
#  cml_render_gradient_bar "Some Title Text" [theme]
# If first argument is numeric -> treated as width.
# If first argument is non-numeric -> treated as text to display between bars.
# -------------------------
cml_render_gradient_bar() {
  local a1="${1:-}" a2="${2:-}"
  local width theme
  # detect numeric first argument
  if [[ -n "$a1" && "$a1" =~ ^[0-9]+$ ]]; then
    width="$a1"; theme="${a2:-${CURRENT_THEME:-CLASSIC}}"
    cml_load_palette "$theme"
    :
  elif [[ -n "$a1" ]]; then
    # first arg looks like text -> render bar, then gradient text, then bar
    theme="${a2:-${CURRENT_THEME:-CLASSIC}}"
    cml_load_palette "$theme"
    width=$(cml_half_width)
    # top bar
    _cml__render_bar_width "$width"
    # text line
    cml_apply_theme_gradient "$a1" "$theme"
    # bottom bar
    _cml__render_bar_width "$width"
    return 0
  else
    width=$(cml_half_width); theme="${a2:-${CURRENT_THEME:-CLASSIC}}"
    cml_load_palette "$theme"
  fi

  # now width+theme set -> render gradient bar
  if cml_truecolor_supported; then
    read -r sr sg sb <<< "$(hex_to_rgb_space "$C_PRIMARY")"
    read -r er eg eb <<< "$(hex_to_rgb_space "$C_SECONDARY")"
    [ "$width" -lt 2 ] && width=2
    local denom=$((width - 1)) i
    for ((i=0;i<width;i++)); do
      local r=$(( sr + (er - sr) * i / denom ))
      local g=$(( sg + (eg - sg) * i / denom ))
      local b=$(( sb + (eb - sb) * i / denom ))
      printf '\033[48;2;%d;%d;%dm ' "$r" "$g" "$b"
    done
    cml_reset_color; printf '\n'
  else
    for ((i=0;i<width;i++)); do printf '█'; done; printf '\n'
  fi
}

# internal helper that renders bar using current C_PRIMARY/C_SECONDARY
_cml__render_bar_width() {
  local width="${1:-$(cml_half_width)}"
  read -r sr sg sb <<< "$(hex_to_rgb_space "$C_PRIMARY")"
  read -r er eg eb <<< "$(hex_to_rgb_space "$C_SECONDARY")"
  if cml_truecolor_supported; then
    [ "$width" -lt 2 ] && width=2
    local denom=$((width - 1)) i
    for ((i=0;i<width;i++)); do
      local r=$(( sr + (er - sr) * i / denom ))
      local g=$(( sg + (eg - sg) * i / denom ))
      local b=$(( sb + (eb - sb) * i / denom ))
      printf '\033[48;2;%d;%d;%dm ' "$r" "$g" "$b"
    done
    cml_reset_color; printf '\n'
  else
    for ((i=0;i<width;i++)); do printf '█'; done; printf '\n'
  fi
}

# -------------------------
# Apply gradient across text characters
# -------------------------
cml_apply_theme_gradient() {
  local text="${1:-}" arg_theme="${2:-}"
  local theme="${arg_theme:-${CURRENT_THEME:-CLASSIC}}"
  cml_load_palette "$theme"
  local len=${#text}
  (( len == 0 )) && { printf '\n'; return; }
  read -r sr sg sb <<< "$(hex_to_rgb_space "$C_PRIMARY")"
  read -r er eg eb <<< "$(hex_to_rgb_space "$C_SECONDARY")"
  local denom=$((len - 1)); (( denom < 1 )) && denom=1
  if cml_truecolor_supported; then
    local i
    for ((i=0;i<len;i++)); do
      local r=$(( sr + (er - sr) * i / denom ))
      local g=$(( sg + (eg - sg) * i / denom ))
      local b=$(( sb + (eb - sb) * i / denom ))
      printf '\033[38;2;%d;%d;%dm%s' "$r" "$g" "$b" "${text:i:1}"
    done
    cml_reset_color; printf '\n'
  else
    printf '%s\n' "$text"
  fi
}

# -------------------------
# cml_colorize: colorize text using either:
#  - first arg is a hex color (#RRGGBB) -> prints text in that color
#  - first arg is a theme name -> applies theme gradient to the text
# If first arg empty -> use CURRENT_THEME
# Usage: cml_colorize "<hex_or_theme_or_empty>" "Your text"
# -------------------------
cml_colorize() {
  local key="${1:-}" text="${2:-}"
  # if key looks like hex
  if [[ "$key" =~ ^#?[0-9A-Fa-f]{6}$ ]]; then
    # normalize to #RRGGBB
    [[ "$key" != \#* ]] && key="#$key"
    rgb_fg_hex "$key"
    printf '%s' "$text"
    cml_reset_color
    printf '\n'
    return
  fi
  # otherwise treat key as theme (or empty => CURRENT_THEME)
  local theme="${key:-${CURRENT_THEME:-CLASSIC}}"
  cml_apply_theme_gradient "$text" "$theme"
}

# -------------------------
# Small title helper
# -------------------------
cml_title() {
  local text="${1:-COLOR MASTER LIBRARY}" theme="${2:-${CURRENT_THEME:-CLASSIC}}"
  cml_render_gradient_bar "$text" "$theme"
}

# -------------------------
# Fallback helper
# -------------------------
cml_fallback_color() {
  local idx="${1:-1}"
  printf '\033[38;5;%dm' "$((30 + (idx % 200)))"
}

# -------------------------
# Ensure CURRENT_THEME from file if present
# -------------------------
THEME_FILE="${THEME_FILE:-$HOME/kh-scripts/library/colors/.cml_theme}"
if [ -f "$THEME_FILE" ]; then
  CURRENT_THEME=$(< "$THEME_FILE")
  CURRENT_THEME="${CURRENT_THEME//[$'\r\n']/}"
  CURRENT_THEME="${CURRENT_THEME^^}"
fi
: "${CURRENT_THEME:=CLASSIC}"

# Quiet colored load message using theme
if cml_truecolor_supported; then
  cml_apply_theme_gradient "✔ COLOR MASTER TRUECOLOR ENGINE LOADED ($CML_TRUECOLOR_VERSION)" "$CURRENT_THEME"
else
  echo "✔ COLOR MASTER TRUECOLOR ENGINE LOADED ($CML_TRUECOLOR_VERSION)"
fi

# End of engine file
