#!/usr/bin/env bash
# COLOR MASTER TRUECOLOR ENGINE
# v1.5.8 — Restored full palette + palettes-file hook + list helper

CML_TRUECOLOR_VERSION="v1.5.8"

# prevent double-source
if [ -n "${CML_TRUECOLOR_LOADED:-}" ]; then
  return 0 2>/dev/null || exit 0
fi
CML_TRUECOLOR_LOADED=1

CML_DIR="${CML_DIR:-$HOME/kh-scripts/library/colors}"
PALETTES_FILE="${PALETTES_FILE:-$CML_DIR/cml-palettes.conf}"
THEME_FILE="${THEME_FILE:-$CML_DIR/.cml_theme}"

# -------------- capability detection --------------
cml_truecolor_supported() {
  local ct="${COLORTERM:-}" tm="${TERM:-}"
  ct="${ct,,}"; tm="${tm,,}"
  [[ "$ct" == *truecolor* || "$ct" == *24bit* || "$tm" == *-truecolor* ]]
}

# -------------- hex -> rgb --------------
hex_to_rgb_space() {
  local hex="${1#\#}"
  hex="${hex^^}"
  if [[ ! "$hex" =~ ^[0-9A-F]{6}$ ]]; then
    printf '255 255 255'
    return
  fi
  printf '%d %d %d' $((16#${hex:0:2})) $((16#${hex:2:2})) $((16#${hex:4:2}))
}

# -------------- low-level fg/bg from hex --------------
rgb_fg_hex() {
  local r g b; read -r r g b <<< "$(hex_to_rgb_space "$1")"
  printf '\033[38;2;%d;%d;%dm' "$r" "$g" "$b"
}
rgb_bg_hex() {
  local r g b; read -r r g b <<< "$(hex_to_rgb_space "$1")"
  printf '\033[48;2;%d;%d;%dm' "$r" "$g" "$b"
}
cml_reset_color() { printf '\033[0m'; }

# -------------- read palette from file helper --------------
# Expect file lines like:
# THEME_NAME|#RRGGBB|#RRGGBB|#RRGGBB(opt accent)
# example:
# NEON:GREEN|#39FF14|#BFFFC9|#00FF88
get_palette_from_file() {
  local theme="$1"
  [ -f "$PALETTES_FILE" ] || return 1
  awk -F'|' -v t="$theme" 'BEGIN{lt=tolower(t)} tolower($1)==lt{gsub(/^[ \t]+|[ \t]+$/,"",$2); gsub(/^[ \t]+|[ \t]+$/,"",$3); gsub(/^[ \t]+|[ \t]+$/,"",$4); print $2 "|" $3 "|" $4; exit}' "$PALETTES_FILE"
}

# -------------- built-in fallback palettes --------------
cml_load_builtin_palette() {
  case "${1:-CLASSIC}" in
    CLASSIC)      printf "#AAAAAA|#FFFFFF|#FFD700" ;;
    NEON:RED)     printf "#FF2D95|#FF9DB3|#FF0040" ;;
    NEON:ORANGE)  printf "#FF8C00|#FFD580|#FF8C00" ;;
    NEON:YELLOW)  printf "#FFF200|#FFF8B0|#FFD700" ;;
    NEON:GREEN)   printf "#39FF14|#BFFFC9|#00FF88" ;;
    NEON:BLUE)    printf "#00A0FF|#80D0FF|#00A0FF" ;;
    NEON:PURPLE)  printf "#9A4DFF|#E0B3FF|#C000FF" ;;
    FOREST)       printf "#0B6623|#3CB371|#228B22" ;;
    DESERT)       printf "#C19A6B|#F0D8A8|#C19A6B" ;;
    OCEAN)        printf "#001F3F|#00CCFF|#007FFF" ;;
    SUMMER)       printf "#FFCC33|#99FF66|#FFCC33" ;;
    WINTER)       printf "#66B2FF|#003366|#66B2FF" ;;
    WILD)         printf "#FF1493|#32CD32|#FF1493" ;;
    SUNSET)       printf "#FF4500|#FFD700|#FF4500" ;;
    MIDNIGHT)     printf "#0B2240|#2E3A59|#0B2240" ;;
    AUTUMN)       printf "#D2691E|#FFDAB9|#D2691E" ;;
    SPRING)       printf "#FFB7C5|#BFF7C5|#FFB7C5" ;;
    RAINBOW)      printf "#FF0000|#FF7F00|#FFFF00" ;;
    *)            printf "#AAAAAA|#FFFFFF|#FFD700" ;;
  esac
}

# -------------- load palette (checks file first) --------------
cml_load_palette() {
  local theme="${1:-${CURRENT_THEME:-CLASSIC}}"
  theme="${theme^^}"
  CURRENT_THEME="$theme"
  local line
  line="$(get_palette_from_file "$theme" 2>/dev/null || true)"
  if [ -n "$line" ]; then
    IFS='|' read -r P1 P2 P3 <<< "$line"
  else
    line="$(cml_load_builtin_palette "$theme")"
    IFS='|' read -r P1 P2 P3 <<< "$line"
  fi
  # normalize (ensure leading #)
  P1="${P1/#/#}"; P2="${P2/#/#}"; P3="${P3/#/#}"
  C_PRIMARY="${P1:-#AAAAAA}"
  C_SECONDARY="${P2:-#FFFFFF}"
  C_ACCENT="${P3:-$C_PRIMARY}"
}

# -------------- theme refresh (reads .cml_theme file) --------------
cml_refresh_theme() {
  if [ -f "$THEME_FILE" ]; then
    local t; t=$(< "$THEME_FILE")
    t="${t//[$'\r\n']/}"; t="${t^^}"
    CURRENT_THEME="${t:-$CURRENT_THEME}"
  fi
  : "${CURRENT_THEME:=CLASSIC}"
  cml_load_palette "$CURRENT_THEME"
  printf '%s' "$CURRENT_THEME"
}

# initialize theme on source
if [ -f "$THEME_FILE" ]; then
  CURRENT_THEME=$(< "$THEME_FILE")
  CURRENT_THEME="${CURRENT_THEME//[$'\r\n']/}"
  CURRENT_THEME="${CURRENT_THEME^^}"
fi
: "${CURRENT_THEME:=CLASSIC}"
cml_load_palette "$CURRENT_THEME"

# -------------- width helper --------------
cml_half_width() {
  local cols=$(tput cols 2>/dev/null || echo 80)
  [ "$cols" -lt 20 ] && echo 20 || echo $((cols / 2))
}

# -------------- render math -> gradient bar --------------
_cml__render_gradient() {
  local width="$1" sr="$2" sg="$3" sb="$4" er="$5" eg="$6" eb="$7"
  local i denom=$(( width - 1 ))
  [ "$width" -lt 2 ] && width=2
  for ((i=0;i<width;i++)); do
    local r=$(( sr + (er - sr) * i / denom ))
    local g=$(( sg + (eg - sg) * i / denom ))
    local b=$(( sb + (eb - sb) * i / denom ))
    printf '\033[48;2;%d;%d;%dm ' "$r" "$g" "$b"
  done
  cml_reset_color; printf '\n'
}

# -------------- gradient bar: numeric -> width, non-numeric -> theme --------------
cml_render_gradient_bar() {
  local a1="${1:-}" a2="${2:-}"
  local width theme
  if [[ -n "$a1" && "$a1" =~ ^[0-9]+$ ]]; then
    width="$a1"; theme="${a2:-${CURRENT_THEME:-CLASSIC}}"
    cml_load_palette "$theme"
  elif [[ -n "$a1" ]]; then
    theme="$a1"
    cml_load_palette "$theme"
    width=$(cml_half_width)
  else
    width=$(cml_half_width); theme="${a2:-${CURRENT_THEME:-CLASSIC}}"
    cml_load_palette "$theme"
  fi

  if cml_truecolor_supported; then
    read -r sr sg sb <<< "$(hex_to_rgb_space "$C_PRIMARY")"
    read -r er eg eb <<< "$(hex_to_rgb_space "$C_SECONDARY")"
    _cml__render_gradient "$width" "$sr" "$sg" "$sb" "$er" "$eg" "$eb"
  else
    for ((i=0;i<width;i++)); do printf '█'; done; printf '\n'
  fi
}

# -------------- gradient text --------------
cml_apply_theme_gradient() {
  local text="${1:-}" arg_theme="${2:-}"
  local theme="${arg_theme:-${CURRENT_THEME:-CLASSIC}}"
  cml_load_palette "$theme"
  local len=${#text}
  (( len == 0 )) && { printf '\n'; return; }
  read -r sr sg sb <<< "$(hex_to_rgb_space "$C_PRIMARY")"
  read -r er eg eb <<< "$(hex_to_rgb_space "$C_SECONDARY")"
  local denom=$((len - 1)); (( denom < 1 )) && denom=1
  if cml_truecolor_supported; then
    for ((i=0;i<len;i++)); do
      local r=$(( sr + (er - sr) * i / denom ))
      local g=$(( sg + (eg - sg) * i / denom ))
      local b=$(( sb + (eb - sb) * i / denom ))
      printf '\033[38;2;%d;%d;%dm%s' "$r" "$g" "$b" "${text:i:1}"
    done
    cml_reset_color; printf '\n'
  else
    printf '%s\n' "$text"
  fi
}

# -------------- convenience colorize --------------
cml_colorize() {
  local key="${1:-}" text="${2:-}"
  if [[ "$key" =~ ^#?[0-9A-Fa-f]{6}$ ]]; then
    [[ "$key" != \#* ]] && key="#$key"
    rgb_fg_hex "$key"
    printf '%s' "$text"
    cml_reset_color; printf '\n'
    return
  fi
  local theme="${key:-${CURRENT_THEME:-CLASSIC}}"
  cml_apply_theme_gradient "$text" "$theme"
}

# -------------- list themes (built-in + file) --------------
cml_list_themes() {
  # builtins
  awk 'BEGIN{print "BUILT-IN:"} {print}' <<'BUILTIN'
CLASSIC
FOREST
DESERT
OCEAN
SUMMER
WINTER
WILD
SUNSET
MIDNIGHT
AUTUMN
SPRING
NEON:RED
NEON:ORANGE
NEON:YELLOW
NEON:GREEN
NEON:BLUE
NEON:PURPLE
RAINBOW
BUILTIN

  if [ -f "$PALETTES_FILE" ]; then
    echo
    echo "FROM $PALETTES_FILE:"
    awk -F'|' '{ gsub(/^[ \t]+|[ \t]+$/,"",$1); if(length($1)>0) print $1 }' "$PALETTES_FILE"
  fi
}

# -------------- fixed engine load banner (SUNSET) --------------
cml_apply_theme_gradient "✔ COLOR MASTER TRUECOLOR ENGINE LOADED (${CML_TRUECOLOR_VERSION})" "SUNSET"

# done
