#!/usr/bin/env bash
# =====================================================
# COLOR MASTER TRUECOLOR ENGINE v1.4.1
# =====================================================
# Single source of truth for all TrueColor operations
# =====================================================

# PREVENT DOUBLE LOAD
if [ -n "$CML_TRUECOLOR_LOADED" ]; then
  return
fi
CML_TRUECOLOR_LOADED=1

CML_TRUECOLOR_VERSION="v1.4.1"

# --- BASE SETUP ---
CML_COLOR_DIR="$HOME/kh-scripts/library/colors"
THEME_FILE="$CML_COLOR_DIR/.cml_theme"

# THEME READ STANDARD
if [ -f "$THEME_FILE" ]; then
  CURRENT_THEME=$(< "$THEME_FILE")
  CURRENT_THEME="${CURRENT_THEME//[$'\r\n']/}"
  CURRENT_THEME="${CURRENT_THEME^^}"
else
  CURRENT_THEME="CLASSIC"
  printf "%s" "$CURRENT_THEME" > "$THEME_FILE"
  sync
fi
[ -z "$CURRENT_THEME" ] && CURRENT_THEME="CLASSIC"

# TRUECOLOR SUPPORT CHECK
cml_truecolor_supported() {
  [ "${COLORTERM,,}" = "truecolor" ] || [ "${COLORTERM,,}" = "24bit" ]
}

# BASIC COLOR HELPERS
rgb_fg() { printf "\033[38;2;%s;%s;%sm" "$1" "$2" "$3"; }
rgb_bg() { printf "\033[48;2;%s;%s;%sm" "$1" "$2" "$3"; }
cml_reset() { printf "\033[0m"; }

# THEME PALETTES
cml_load_palette() {
  case "$1" in
    CLASSIC) PALETTE=(255 0 0 255 255 0 0 255 255 255 0 255) ;;
    FOREST)  PALETTE=(0 128 0 0 255 0 0 128 64 0 255 0) ;;
    DESERT)  PALETTE=(210 180 140 240 230 140 189 183 107 255 228 181) ;;
    OCEAN)   PALETTE=(0 0 128 0 0 255 0 191 255 135 206 250) ;;
    SUMMER)  PALETTE=(255 255 0 173 255 47 0 255 127 124 252 0) ;;
    WINTER)  PALETTE=(0 191 255 70 130 180 173 216 230 176 224 230) ;;
    WILD)    PALETTE=(255 20 147 0 255 127 124 252 0 0 255 255) ;;
    NEON:RED) PALETTE=(255 0 128 255 105 180 255 0 255 255 182 193) ;;
    NEON:ORANGE) PALETTE=(255 140 0 255 165 0 255 215 0 255 69 0) ;;
    NEON:BLUE) PALETTE=(0 191 255 0 255 255 135 206 250 0 0 255) ;;
    NEON:PURPLE) PALETTE=(128 0 128 186 85 211 218 112 214 221 160 221) ;;
    *) PALETTE=(255 255 255 200 200 200 128 128 128 80 80 80) ;;
  esac
}

# FALLBACK
cml_fallback_color() { printf "\033[3%sm" "$1"; }

# LOAD SUCCESS MESSAGE
printf "âœ” COLOR MASTER TRUECOLOR ENGINE LOADED (%s)\n" "$CML_TRUECOLOR_VERSION"
