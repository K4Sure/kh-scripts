#!/usr/bin/env bash
# =========================================================
# COLOR MASTER LIBRARY — TRUECOLOR ENGINE (v1.1.1)
# =========================================================
# SINGLE SOURCE OF TRUTH FOR ALL TRUECOLOR OPERATIONS
# - Hybrid TrueColor/256 fallback model
# - Theme adaptive gradient rendering
# - Clean reset system
# - No 'tr' usage anywhere (Unicode-safe)
# =========================================================

CML_TRUECOLOR_VERSION="v1.1.1"

# ------------------------------
# TRUECOLOR SUPPORT CHECK
# ------------------------------
cml_truecolor_supported() {
  [[ "$COLORTERM" == *"truecolor"* || "$COLORTERM" == *"24bit"* ]]
}

# ------------------------------
# SAFE COLOR RESET
# ------------------------------
cml_reset_color() {
  printf '\033[0m'
}

# ------------------------------
# HEX → RGB CONVERTER (SAFE)
# ------------------------------
hex_to_rgb() {
  local hex="\${1#"#"}"
  if [[ ! "\$hex" =~ ^[0-9A-Fa-f]{6}$ ]]; then
    echo "255 255 255"
    return
  fi
  local r=\$((16#\${hex:0:2}))
  local g=\$((16#\${hex:2:2}))
  local b=\$((16#\${hex:4:2}))
  echo "\$r \$g \$b"
}

# ------------------------------
# RGB FOREGROUND / BACKGROUND
# ------------------------------
rgb_fg() { printf '\033[38;2;%s;%s;%sm' \$1 \$2 \$3; }
rgb_bg() { printf '\033[48;2;%s;%s;%sm' \$1 \$2 \$3; }

# ------------------------------
# LOAD PALETTE PER THEME
# ------------------------------
cml_load_palette() {
  local THEME="\${1^^}"
  case "\$THEME" in
    "NEON:RED")     C1="#FF1744"; C2="#FF8A80"; C3="#FFDDE0" ;;
    "NEON:ORANGE")  C1="#FF8C00"; C2="#FFD580"; C3="#FFF0C2" ;;
    "NEON:BLUE")    C1="#0091EA"; C2="#80D8FF"; C3="#E0F7FA" ;;
    "NEON:PURPLE")  C1="#9A4DFF"; C2="#E0B3FF"; C3="#F2E5FF" ;;
    "OCEAN")        C1="#007FFF"; C2="#66CCFF"; C3="#CCFFFF" ;;
    "FOREST")       C1="#228B22"; C2="#A8E6A3"; C3="#E5FFE5" ;;
    "CLASSIC"|*)    C1="#AAAAAA"; C2="#DDDDDD"; C3="#FFFFFF" ;;
  esac
}

# ------------------------------
# GRADIENT RENDERING BAR
# ------------------------------
cml_render_gradient_bar() {
  local width="\${1:-40}"
  local theme="\${2:-\$CURRENT_THEME}"
  cml_load_palette "\$theme"
  local start_rgb=(\$(hex_to_rgb "\$C1"))
  local end_rgb=(\$(hex_to_rgb "\$C2"))

  for ((i=0; i<width; i++)); do
    local ratio=\$(awk -v i="\$i" -v w="\$width" 'BEGIN{print i/(w-1)}')
    local r=\$(awk -v s="\${start_rgb[0]}" -v e="\${end_rgb[0]}" -v t="\$ratio" 'BEGIN{printf "%d", s+(e-s)*t}')
    local g=\$(awk -v s="\${start_rgb[1]}" -v e="\${end_rgb[1]}" -v t="\$ratio" 'BEGIN{printf "%d", s+(e-s)*t}')
    local b=\$(awk -v s="\${start_rgb[2]}" -v e="\${end_rgb[2]}" -v t="\$ratio" 'BEGIN{printf "%d", s+(e-s)*t}')
    if cml_truecolor_supported; then
      printf '\033[48;2;%d;%d;%dm ' "\$r" "\$g" "\$b"
    else
      printf '\033[48;5;%dm ' \$((16+(i%200)))
    fi
  done
  cml_reset_color
  printf "\n"
}

# ------------------------------
# GRADIENT TEXT RENDER
# ------------------------------
cml_apply_theme_gradient() {
  local text="\$1"
  local theme="\${2:-\$CURRENT_THEME}"
  cml_load_palette "\$theme"
  local start_rgb=(\$(hex_to_rgb "\$C1"))
  local end_rgb=(\$(hex_to_rgb "\$C2"))
  local len=\${#text}

  for ((i=0; i<len; i++)); do
    local ratio=\$(awk -v i="\$i" -v l="\$len" 'BEGIN{print i/(l-1)}')
    local r=\$(awk -v s="\${start_rgb[0]}" -v e="\${end_rgb[0]}" -v t="\$ratio" 'BEGIN{printf "%d", s+(e-s)*t}')
    local g=\$(awk -v s="\${start_rgb[1]}" -v e="\${end_rgb[1]}" -v t="\$ratio" 'BEGIN{printf "%d", s+(e-s)*t}')
    local b=\$(awk -v s="\${start_rgb[2]}" -v e="\${end_rgb[2]}" -v t="\$ratio" 'BEGIN{printf "%d", s+(e-s)*t}')
    local ch="\${text:i:1}"
    if cml_truecolor_supported; then
      printf '\033[38;2;%d;%d;%dm%s' "\$r" "\$g" "\$b" "\$ch"
    else
      printf '\033[38;5;%dm%s' \$((16+(i%200))) "\$ch"
    fi
  done
  cml_reset_color
  printf "\n"
}

# ------------------------------
# FALLBACK 256-COLOR INDEX
# ------------------------------
cml_fallback_color() {
  local index="\$1"
  printf '\033[38;5;%dm' "\$((30+index))"
}

# ------------------------------
# TITLE RENDER (UTILITY)
# ------------------------------
cml_title() {
  local text="\$1"
  local theme="\${2:-\$CURRENT_THEME}"
  echo
  cml_apply_theme_gradient "\$text" "\$theme"
  cml_render_gradient_bar 50 "\$theme"
}
