#!/bin/bash

# ============================================================================
# TERMUX COLOR MASTER LIBRARY v3.1
# Universal color scripting library for Termux
# Location: /data/data/com.termux/files/home/kh-scripts/library/colors/
# ============================================================================

# Prevent multiple loads
if [[ -n "$CML_LOADED" ]]; then
    return 0 2>/dev/null || exit 0
fi

# Metadata
CML_VERSION="3.1.0"
CML_PATH="/data/data/com.termux/files/home/kh-scripts/library/colors"
CML_DEBUG=${CML_DEBUG:-0}

# ============================================================================
# COLOR DETECTION
# ============================================================================
cml_detect_color_support() {
    if [[ "$COLORTERM" == "truecolor" || "$COLORTERM" == "24bit" ]]; then
        CML_COLOR_MAX=16777216
        CML_COLOR_SUPPORT="truecolor"
    elif [[ "$TERM" == *"256color"* ]]; then
        CML_COLOR_MAX=256
        CML_COLOR_SUPPORT="256color"
    else
        CML_COLOR_MAX=16
        CML_COLOR_SUPPORT="16color"
    fi
}

if [[ -z "$CML_COLOR_SUPPORT" ]]; then
    cml_detect_color_support
fi

# ============================================================================
# BASIC 16 COLORS
# ============================================================================
CML_RESET='\033[0m'
CML_BLACK='\033[0;30m'
CML_RED='\033[0;31m'
CML_GREEN='\033[0;32m'
CML_YELLOW='\033[0;33m'
CML_BLUE='\033[0;34m'
CML_MAGENTA='\033[0;35m'
CML_CYAN='\033[0;36m'
CML_WHITE='\033[0;37m'

CML_BRIGHT_BLACK='\033[0;90m'
CML_BRIGHT_RED='\033[0;91m'
CML_BRIGHT_GREEN='\033[0;92m'
CML_BRIGHT_YELLOW='\033[0;93m'
CML_BRIGHT_BLUE='\033[0;94m'
CML_BRIGHT_MAGENTA='\033[0;95m'
CML_BRIGHT_CYAN='\033[0;96m'
CML_BRIGHT_WHITE='\033[0;97m'

# ============================================================================
# THEME SUPPORT SYSTEM
# ============================================================================

# Default theme
CML_THEME=${CML_THEME:-"cyber_neon_cyan"}

# RGB helpers
cml_rgb_fg() { printf "\033[38;2;%s;%s;%sm" "$1" "$2" "$3"; }
cml_rgb_bg() { printf "\033[48;2;%s;%s;%sm" "$1" "$2" "$3"; }

# Theme loader
cml_load_theme() {
    case "$CML_THEME" in
        "cyber_neon_cyan")
            THEME_PRIMARY=$(cml_rgb_fg 57 255 20)     # Neon green
            THEME_SECONDARY=$(cml_rgb_fg 0 255 255)   # Cyan
            THEME_ACCENT=$(cml_rgb_fg 255 20 147)     # Neon pink
            THEME_WARNING=$(cml_rgb_fg 255 255 0)     # Bright yellow
            ;;
        "solarized_night_grey")
            THEME_PRIMARY=$(cml_rgb_fg 131 148 150)   # Base0 grey
            THEME_SECONDARY=$(cml_rgb_fg 38 139 210)  # Blue
            THEME_ACCENT=$(cml_rgb_fg 181 137 0)      # Yellow-orange
            THEME_WARNING=$(cml_rgb_fg 220 50 47)     # Red
            ;;
        "forest_dawn_green")
            THEME_PRIMARY=$(cml_rgb_fg 34 139 34)     # Forest green
            THEME_SECONDARY=$(cml_rgb_fg 139 69 19)   # Earth brown
            THEME_ACCENT=$(cml_rgb_fg 70 130 180)     # Sky blue
            THEME_WARNING=$(cml_rgb_fg 255 140 0)     # Warm orange
            ;;
        "hot_warm_red")
            THEME_PRIMARY=$(cml_rgb_fg 255 69 0)      # Fiery red-orange
            THEME_SECONDARY=$(cml_rgb_fg 255 140 0)   # Dark orange
            THEME_ACCENT=$(cml_rgb_fg 255 215 0)      # Golden yellow
            THEME_WARNING=$(cml_rgb_fg 255 99 71)     # Tomato red
            ;;
        "cold_freezing_blue")
            THEME_PRIMARY=$(cml_rgb_fg 0 191 255)     # Deep sky blue
            THEME_SECONDARY=$(cml_rgb_fg 173 216 230) # Light blue
            THEME_ACCENT=$(cml_rgb_fg 224 255 255)    # Icy white
            THEME_WARNING=$(cml_rgb_fg 0 255 255)     # Cyan
            ;;
        *)
            THEME_PRIMARY=$CML_GREEN
            THEME_SECONDARY=$CML_CYAN
            THEME_ACCENT=$CML_BRIGHT_MAGENTA
            THEME_WARNING=$CML_YELLOW
            ;;
    esac
}
cml_load_theme

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================
cml_print() {
    printf '%b%s%b' "$1" "$2" "$CML_RESET"
}

cml_print_theme() {
    local role="$1"
    local text="$2"
    case "$role" in
        primary)   cml_print "$THEME_PRIMARY" "$text" ;;
        secondary) cml_print "$THEME_SECONDARY" "$text" ;;
        accent)    cml_print "$THEME_ACCENT" "$text" ;;
        warning)   cml_print "$THEME_WARNING" "$text" ;;
        *)         cml_print "$CML_WHITE" "$text" ;;
    esac
}

cml_log_info()    { cml_print "$CML_CYAN"   "[INFO] ";    printf '%s\n' "$1"; }
cml_log_success() { cml_print "$CML_GREEN"  "[SUCCESS] "; printf '%s\n' "$1"; }
cml_log_warning() { cml_print "$CML_YELLOW" "[WARNING] "; printf '%s\n' "$1"; }
cml_log_error()   { cml_print "$CML_RED"    "[ERROR] ";   printf '%s\n' "$1"; }

cml_test_all() {
    echo "=== Color Master Library Test ==="
    echo "Version: $CML_VERSION"
    echo "Support: $CML_COLOR_SUPPORT"
    echo "Theme: $CML_THEME"
    echo ""

    echo "--- Basic Colors ---"
    cml_print "$CML_RED" "Red "
    cml_print "$CML_GREEN" "Green "
    cml_print "$CML_BLUE" "Blue"
    echo ""

    if [[ "$CML_COLOR_SUPPORT" == "truecolor" ]]; then
        echo "--- Theme Colors (True Color) ---"
        cml_print_theme "primary" "Primary "
        cml_print_theme "secondary" "Secondary "
        cml_print_theme "accent" "Accent "
        cml_print_theme "warning" "Warning"
        echo ""
    fi

    echo "--- Logging Demo ---"
    cml_log_info "Information message"
    cml_log_success "Success message"
    cml_log_warning "Warning message"
    cml_log_error "Error message"
}

# ============================================================================
# THEME SWITCHER + LIST
# ============================================================================
cml_theme_resolve() {
    case "$1" in
        cyan) echo "cyber_neon_cyan" ;;
        grey|gray) echo "solarized_night_grey" ;;
        green) echo "forest_dawn_green" ;;
        red|warm|hot) echo "hot_warm_red" ;;
        blue|cold|freezing) echo "cold_freezing_blue" ;;
        *) echo "" ;;
    esac
}

cml_theme_list() {
    echo "=== Available Themes ==="
    for color in cyan grey green red blue; do
        local theme
        theme=$(cml_theme_resolve "$color")

        # Temporarily load theme for preview
        local prev_theme="$CML_THEME"
        CML_THEME="$theme"
        cml_load_theme

        # Mark current
        local mark=" "
        if [[ "$theme" == "$prev_theme" ]]; then
            mark="✓"
        fi

        printf "%s %-22s (%s) " "$mark" "$theme" "$color"
        cml_print_theme primary "■ "
        cml_print_theme secondary "■ "
        cml_print_theme accent "■ "
        cml_print_theme warning "■ "
        echo ""

        # Restore theme
        CML_THEME="$prev_theme"
        cml_load_theme
    done
    echo "========================"
}

cml_theme_switch() {
    local keyword="$1"

    if [[ -z "$keyword" ]]; then
        cml_theme_list
        return 0
    fi

    local resolved
    resolved=$(cml_theme_resolve "$keyword")

    if [[ -z "$resolved" ]]; then
        echo "Unknown theme: $keyword"
        echo "Available colors: cyan, grey, green, red, blue"
        return 1
    fi

    CML_THEME="$resolved"
    cml_load_theme
    export CML_THEME THEME_PRIMARY THEME_SECONDARY THEME_ACCENT THEME_WARNING

    cml_log_success "Theme switched to '$CML_THEME'"
}

# Aliases
alias cml-theme='cml_theme_switch'
alias cml-reload="source $CML_PATH/color_master_library.sh"
alias cml-test='cml_test_all'

# ============================================================================
# EXPORTS
# ============================================================================
export CML_VERSION CML_PATH CML_DEBUG CML_COLOR_MAX CML_COLOR_SUPPORT
export CML_RESET CML_BLACK CML_RED CML_GREEN CML_YELLOW CML_BLUE CML_MAGENTA CML_CYAN CML_WHITE
export CML_BRIGHT_BLACK CML_BRIGHT_RED CML_BRIGHT_GREEN CML_BRIGHT_YELLOW CML_BRIGHT_BLUE CML_BRIGHT_MAGENTA CML_BRIGHT_CYAN CML_BRIGHT_WHITE
export CML_THEME THEME_PRIMARY THEME_SECONDARY THEME_ACCENT THEME_WARNING

export -f cml_detect_color_support cml_rgb_fg cml_rgb_bg cml_load_theme
export -f cml_print cml_print_theme cml_log_info cml_log_success cml_log_warning cml_log_error cml_test_all
export -f cml_theme_resolve cml_theme_list cml_theme_switch

export CML_LOADED=1

# ============================================================================
# BANNER
# ============================================================================
if [[ $- == *i* ]] && [[ ${CML_NO_BANNER:-0} -eq 0 ]]; then
    cml_print "$CML_GREEN" "✓ "
    printf "Color Library v%s loaded (%s mode, theme: %s)\n" "$CML_VERSION" "$CML_COLOR_SUPPORT" "$CML_THEME"
fi
