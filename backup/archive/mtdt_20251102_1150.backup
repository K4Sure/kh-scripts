#!/data/data/com.termux/files/usr/bin/bash
# Usage: mtdt "/path/to/folder"

INPUT_DIR="$1"

# --- sanity checks ---
if [ -z "$INPUT_DIR" ]; then
  echo -e "\e[31m[âœ˜] Usage: mtdt <directory>\e[0m"; exit 1
fi
if [ ! -d "$INPUT_DIR" ]; then
  echo -e "\e[31m[âœ˜] Directory not found: $INPUT_DIR\e[0m"; exit 1
fi
if ! command -v ffprobe >/dev/null 2>&1; then
  echo -e "\e[31m[âœ˜] ffprobe not found. Install ffmpeg.\e[0m"; exit 1
fi

# --- outputs ---
OUT_TXT="$INPUT_DIR/metadata.txt"
OUT_CSV="$INPUT_DIR/metadata.csv"

# ensure clean
printf '\xEF\xBB\xBF' > "$OUT_TXT"
printf '\xEF\xBB\xBF' > "$OUT_CSV"

# CSV header
echo "File,Codec,Channels,Sample Rate,Bitrate,Mode,Title,Artist,Album,Album Artist,Year,Genre" >> "$OUT_CSV"

# --- spinner ---
spinner() {
  local pid=$1
  local spin='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
  local i=0
  while kill -0 "$pid" 2>/dev/null; do
    i=$(( (i+1) % 10 ))
    printf "\r\e[36m[%s] Extracting metadata... \e[0m" "${spin:$i:1}"
    sleep 0.1
  done
  printf "\r\e[32m[âœ”] Metadata extraction completed!        \e[0m\n"
}

# --- background worker ---
nohup bash -c '
  set -e
  shopt -s nullglob

  # function to print aligned key-value
  kv() { printf "%-12s %s\n" "$1:" "$2"; }

  for FILE in "'"$INPUT_DIR"'"/*.mp3 "'"$INPUT_DIR"'"/*.m4a "'"$INPUT_DIR"'"/*.opus "'"$INPUT_DIR"'"/*.flac "'"$INPUT_DIR"'"/*.wav; do
    [ -e "$FILE" ] || continue
    BASENAME=$(basename "$FILE")

    CODEC=$(ffprobe -v error -select_streams a:0 -show_entries stream=codec_name \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    CHANNEL_LAYOUT=$(ffprobe -v error -select_streams a:0 -show_entries stream=channel_layout \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    if [ -z "$CHANNEL_LAYOUT" ] || [ "$CHANNEL_LAYOUT" = "unknown" ]; then
      CH_COUNT=$(ffprobe -v error -select_streams a:0 -show_entries stream=channels \
                -of default=nokey=1:noprint_wrappers=1 "$FILE")
      case "$CH_COUNT" in
        1) CHANNEL_LAYOUT="mono" ;;
        2) CHANNEL_LAYOUT="stereo" ;;
        *) CHANNEL_LAYOUT="${CH_COUNT}-ch" ;;
      esac
    fi
    SAMPLE_RATE=$(ffprobe -v error -select_streams a:0 -show_entries stream=sample_rate \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    BITRATE=$(ffprobe -v error -select_streams a:0 -show_entries stream=bit_rate \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    if [[ -z "$BITRATE" || "$BITRATE" = "N/A" || "$BITRATE" = "0" ]]; then
      MODE="VBR"; BITRATE_SHOW="N/A"
    else
      MODE="CBR"; BITRATE_SHOW="$BITRATE"
    fi

    TITLE=$(ffprobe -v error -show_entries format_tags=title \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    ARTIST=$(ffprobe -v error -show_entries format_tags=artist \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    ALBUM=$(ffprobe -v error -show_entries format_tags=album \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    ALBUM_ARTIST=$(ffprobe -v error -show_entries format_tags=album_artist \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    YEAR=$(ffprobe -v error -show_entries format_tags=date \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")
    GENRE=$(ffprobe -v error -show_entries format_tags=genre \
            -of default=nokey=1:noprint_wrappers=1 "$FILE")

    # --- write TXT (aligned) ---
    {
      echo "=== ðŸŽµ File: $BASENAME ==="
      kv "Codec"        "${CODEC:-N/A}"
      kv "Channels"     "${CHANNEL_LAYOUT:-N/A}"
      kv "Sample Rate"  "${SAMPLE_RATE:-N/A} Hz"
      kv "Bitrate"      "$BITRATE_SHOW"
      kv "Mode"         "$MODE"
      echo ""
      kv "Title"        "${TITLE:-N/A}"
      kv "Artist"       "${ARTIST:-N/A}"
      kv "Album"        "${ALBUM:-N/A}"
      kv "Album Artist" "${ALBUM_ARTIST:-N/A}"
      kv "Year"         "${YEAR:-N/A}"
      kv "Genre"        "${GENRE:-N/A}"
      echo ""
    } >> "'"$OUT_TXT"'"

    # --- write CSV ---
    echo "\"$BASENAME\",\"${CODEC:-N/A}\",\"${CHANNEL_LAYOUT:-N/A}\",\"${SAMPLE_RATE:-N/A}\",\"$BITRATE_SHOW\",\"$MODE\",\"${TITLE:-N/A}\",\"${ARTIST:-N/A}\",\"${ALBUM:-N/A}\",\"${ALBUM_ARTIST:-N/A}\",\"${YEAR:-N/A}\",\"${GENRE:-N/A}\"" >> "'"$OUT_CSV"'"
  done
' >/dev/null 2>&1 &

WORKER_PID=$!
spinner "$WORKER_PID"
