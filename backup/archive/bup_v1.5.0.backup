#!/usr/bin/env bash
# File: /data/data/com.termux/files/home/kh-scripts/bup
# Purpose: Globally callable backup helper ("bup") with branded emoji, TrueColor feedback, and progress bar

SCRIPT_VERSION="v1.5.0"

# --- Color palette (CML TrueColor) ---
CLR_OK=$'\e[38;2;0;200;0m'        # green
CLR_WARN=$'\e[38;2;255;200;0m'    # yellow
CLR_ERR=$'\e[38;2;220;0;0m'       # red
CLR_INFO=$'\e[38;2;120;160;255m'  # light blue
CLR_BACKUP=$'\e[38;2;0;180;220m'  # cyan
CLR_RESET=$'\e[0m'

# ===============================================================
# PROGRESS BAR
# ===============================================================
PB_TOTAL=0
PB_CURRENT=0
PB_START=0

progress_init() {
  PB_TOTAL=$1
  PB_CURRENT=0
  PB_START=$(date +%s)
}

progress_update() {
  PB_CURRENT=$((PB_CURRENT+1))
  progress_render
}

progress_render() {
  local now elapsed pct width fill_len empty_len eta eta_min eta_sec eta_str
  now=$(date +%s)
  elapsed=$((now - PB_START))
  [ $elapsed -eq 0 ] && elapsed=1

  pct=$(awk "BEGIN {printf \"%.4f\", $PB_CURRENT/$PB_TOTAL}")
  width=$(tput cols 2>/dev/null || echo 80)
  width=$((width - 50))
  [ $width -lt 30 ] && width=30

  fill_len=$(awk -v w=$width -v p=$pct 'BEGIN {printf "%d", w*p}')
  empty_len=$((width - fill_len))

  local filled empty divider bar
  filled="${CLR_BACKUP}$(printf '━%.0s' $(seq 1 $fill_len))${CLR_RESET}"
  empty="${CLR_INFO}$(printf '─%.0s' $(seq 1 $empty_len))${CLR_RESET}"
  divider=""
  [ $fill_len -lt $width ] && divider="${CLR_OK}╸${CLR_RESET}"
  bar="${filled}${divider}${empty}"

  eta=$(( (PB_TOTAL - PB_CURRENT) * elapsed / (PB_CURRENT>0?PB_CURRENT:1) ))
  eta_min=$((eta/60))
  eta_sec=$((eta%60))
  eta_str=$(printf "%02d:%02d" $eta_min $eta_sec)

  printf "\r${CLR_OK}%3d${CLR_RESET}/${CLR_INFO}%d${CLR_RESET} [%s] ${CLR_OK}%5.1f%%%s ETA ${CLR_INFO}%s${CLR_RESET}" \
    "$PB_CURRENT" "$PB_TOTAL" "$bar" "$(echo "$pct*100" | bc -l)" "" "$eta_str"
}

progress_finish() {
  echo
}

# ===============================================================
# BACKUP LOGIC
# ===============================================================
backup_one() {
  local src="$1"
  local provided_lib="$2"
  local SRC_ROOT="/data/data/com.termux/files/home/kh-scripts"
  local BK_ROOT="/data/data/com.termux/files/home/kh-scripts/backup"

  # SAFETY GUARD
  case "$src" in
    "$BK_ROOT"|"$BK_ROOT"/*) 
      echo "${CLR_WARN}⚠️ Refusing to back up files already inside the backup folder:${CLR_RESET} $src" >&2
      return 5
      ;;
  esac

  mkdir -p "$BK_ROOT"

  local fn; fn="$(basename -- "$src")"
  local parent; parent="$(basename "$(dirname "$src")")"
  local lowerfn="${fn,,}"
  local lowerparent="${parent,,}"
  local lib="${provided_lib:-}"

  # Library detection
  if [ -z "$lib" ]; then
    case "$lowerfn" in
      cml|truecolor|colormaster ) lib="cml" ;;
      dbml|dynamicbox|box ) lib="dbml" ;;
      csml|symbol|characters ) lib="csml" ;;
      pml|parallel ) lib="pml" ;;
      *) 
        case "$lowerparent" in
          cml) lib="cml" ;;
          dbml) lib="dbml" ;;
          csml) lib="csml" ;;
          pml) lib="pml" ;;
          *) lib="" ;;
        esac
      ;;
    esac
  fi

  # Ensure dirs
  if [ -n "$lib" ]; then
    mkdir -p "$BK_ROOT/$lib" "$BK_ROOT/$lib/old" "$BK_ROOT/$lib/archive"
  else
    mkdir -p "$BK_ROOT" "$BK_ROOT/old"
  fi

  # Extract SCRIPT_VERSION
  local script_version
  script_version="$(sed -n '1,120p' -- "$src" | sed -n 's/^[[:space:]]*SCRIPT_VERSION[[:space:]]*=[[:space:]]*["'\'']\(v[0-9]\+\.[0-9]\+\.[0-9]\+\)["'\'']/\1/p' | head -n1 || true)"

  # Determine backup filename
  local target
  if printf '%s' "$fn" | grep -Eq '[_-]v[0-9]+\.[0-9]+\.[0-9]+'; then
    local ts; ts=$(date '+%Y%m%d_%H%M')
    target="${fn}_${ts}.backup"
  else
    if [ -n "$script_version" ]; then
      target="${fn}_${script_version}.backup"
    else
      local ds; ds=$(date '+%Y%m%d_%H%M')
      target="${fn}_${ds}.backup"
    fi
  fi

  # Destination
  local dest
  if [ -n "$lib" ]; then
    dest="$BK_ROOT/$lib/$target"
  else
    dest="$BK_ROOT/$target"
  fi

  # Handle collisions
  if [ -e "$dest" ]; then
    if [ -n "$lib" ]; then
      mv -n -- "$dest" "$BK_ROOT/$lib/old/" 2>/dev/null || {
        local nowts; nowts=$(date '+%Y%m%d_%H%M')
        mv -- "$dest" "$BK_ROOT/$lib/old/${target}.${nowts}" || true
      }
    else
      mv -n -- "$dest" "$BK_ROOT/old/" 2>/dev/null || {
        local nowts; nowts=$(date '+%Y%m%d_%H%M')
        mv -- "$dest" "$BK_ROOT/old/${target}.${nowts}" || true
      }
    fi
  fi

  # Copy
  if cp -p -- "$src" "$dest"; then
    : # silent, progress bar handles feedback
  else
    echo "${CLR_ERR}❌ Backup failed for:${CLR_RESET} $src" >&2
  fi
}

backup_script() {
  local input="$1"
  local provided_lib="$2"
  local SRC_ROOT="/data/data/com.termux/files/home/kh-scripts"
  local BK_ROOT="/data/data/com.termux/files/home/kh-scripts/backup"

  [ -n "$input" ] || { echo "${CLR_INFO}ℹ️ Usage:${CLR_RESET} bup <file-or-folder> [library]" >&2; return 2; }

  local src="$input"
  if [ ! -e "$src" ]; then
    if [ -e "$SRC_ROOT/$input" ]; then
      src="$SRC_ROOT/$input"
    else
      echo "${CLR_ERR}❌ Not found:${CLR_RESET} $input or $SRC_ROOT/$input" >&2
      return 3
    fi
  fi

  # SAFETY GUARD
  case "$src" in
    "$BK_ROOT"|"$BK_ROOT"/*) 
      echo "${CLR_WARN}⚠️ Refusing to back up the backup folder or its contents:${CLR_RESET} $src" >&2
      return 6
      ;;
  esac

  if [ -f "$src" ]; then
    progress_init 1
    backup_one "$src" "$provided_lib"
    progress_update
    progress_finish
  elif [ -d "$src" ]; then
    local total_files
    total_files=$(find "$src" -maxdepth 1 -type f | wc -l)
    progress_init "$total_files"
    for f in "$src"/*; do
      [ -f "$f" ] && { backup_one "$f" "$provided_lib"; progress_update; }
    done
    progress_finish
  else
    echo "${CLR_ERR}❌ Unsupported type:${CLR_RESET} $src" >&2
    return 4
  fi
}

# Entry point
backup_script "$@"
