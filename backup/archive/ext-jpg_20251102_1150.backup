#!/data/data/com.termux/files/usr/bin/bash
# ext-jpg — Extract JPG from all audio files in a folder (Clean Central Progress)

# ===== CONFIGURATION =====
PARALLEL_JOBS=2
SPINNER_FRAMES=('⠋' '⠙' '⠹' '⠸' '⠼' '⠴' '⠦' '⠧' '⠇' '⠏')

# ===== FUNCTIONS =====

check_dependencies() {
    local missing=()
    for cmd in ffmpeg parallel; do
        command -v "$cmd" >/dev/null 2>&1 || missing+=("$cmd")
    done
    if [ ${#missing[@]} -ne 0 ]; then
        echo "Error: Missing dependencies: ${missing[*]}"
        echo "Install with: pkg install ${missing[*]}"
        exit 1
    fi
}

# Centralised spinner + count
show_progress_grouped() {
    local processed=0 frame=0
    while [ $processed -lt $TOTAL ]; do
        processed=$(wc -l < "$LOG" 2>/dev/null || echo 0)
        local spin="${SPINNER_FRAMES[frame]}"
        frame=$(( (frame + 1) % ${#SPINNER_FRAMES[@]} ))
        printf "\r\033[K%s Processing %d of %d files" "$spin" "$processed" "$TOTAL"
        sleep 0.15
    done
    printf "\r\033[K✔ Processing %d of %d files\n" "$TOTAL" "$TOTAL"
}

# Process a single file (silent except logging)
process_file() {
    local file="$1" log="$2"
    local base=$(basename "$file")
    local out="${file%.*}.jpg"
    if ffmpeg -loglevel error -i "$file" -an -vcodec copy "$out" 2>/dev/null; then
        [ -f "$out" ] && echo "OK:$base" >> "$log" && return 0
    fi
    echo "FAIL:$base" >> "$log"
}
export -f process_file

# Summary report
print_summary() {
    local end=$(date +%s)
    local dur=$((end - start))
    (( dur < 0 )) && dur=0  # safety net

    # Shorten path
    local short_path="${TARGET/\/storage\/emulated\/0/~~}"

    local ok=$(grep -c "OK:" "$LOG")
    local fail=$(grep -c "FAIL:" "$LOG")

    echo -e "\n=== SUMMARY ==="
    echo "Folder Path : $short_path"
    echo "Total Audio Files : $TOTAL"
    echo "Total New JPGs Extracted : $ok"
    echo "Total Extraction Failed : $fail"
    echo
    echo
}

# ===== MAIN =====
check_dependencies
TARGET="${1:-.}"
[ ! -d "$TARGET" ] && echo "Error: '$TARGET' not found" && exit 1

LOG=$(mktemp)
trap "rm -f '$LOG'" EXIT
start=$(date +%s)

mapfile -t FILES < <(find "$TARGET" -maxdepth 1 -type f \( -iname "*.mp3" -o -iname "*.m4a" -o -iname "*.aac" -o -iname "*.flac" \))
TOTAL=${#FILES[@]}
[ $TOTAL -eq 0 ] && echo "No audio files found" && exit 0

echo "Found $TOTAL audio files"
printf "%s\n" "${FILES[@]}" | parallel -j "$PARALLEL_JOBS" --no-notice process_file "{}" "$LOG" >/dev/null 2>&1 &

show_progress_grouped
wait
print_summary

