#!/usr/bin/env bash
# Dynamic Box Master Library (DBML)
# Version: v4.1.0
# Changelog: CSML integration (symbols are tofu-safe)

DBML_VERSION="v4.1.0"
DBML_LIB_DIR="${HOME}/kh-scripts/library/dynamic_box"
DBML_CML_LOADED=0
DBML_CSML_LOADED=0

# --- Try to load CSML for symbol safety ---
dbml_use_csml() {
  local csml_path="${1:-$HOME/kh-scripts/library/characters_symbols/csml_template.sh}"
  if [[ -f "$csml_path" ]]; then
    # shellcheck disable=SC1090
    source "$csml_path"
    DBML_CSML_LOADED=1
    return 0
  fi
  return 1
}

# Detect if terminal supports UTF-8
_dbml_supports_unicode() {
  case "${LC_ALL:-${LANG:-}}" in
    *UTF-8*|*UTF8*) return 0;;
    *) return 1;;
  esac
}

# Symbol resolver: use CSML if loaded, else fallback
_dbml_symbol() {
  local key="$1" fallback="$2"
  if (( DBML_CSML_LOADED )); then
    csml_get "$key" "$fallback"
  else
    printf "%s" "$fallback"
  fi
}

# Box charset builder
_dbml_charset() {
  local style="$1"
  local -n out=$2
  if _dbml_supports_unicode; then
    case "$style" in
      single)
        out=(
          "$(_dbml_symbol box.single.tl ┌)"
          "$(_dbml_symbol box.single.tr ┐)"
          "$(_dbml_symbol box.single.bl └)"
          "$(_dbml_symbol box.single.br ┘)"
          "$(_dbml_symbol box.single.v │)"
          "$(_dbml_symbol box.single.h ─)"
        ) ;;
      double)
        out=(
          "$(_dbml_symbol box.double.tl ╔)"
          "$(_dbml_symbol box.double.tr ╗)"
          "$(_dbml_symbol box.double.bl ╚)"
          "$(_dbml_symbol box.double.br ╝)"
          "$(_dbml_symbol box.double.v ║)"
          "$(_dbml_symbol box.double.h ═)"
        ) ;;
      rounded)
        out=(
          "$(_dbml_symbol box.rounded.tl ╭)"
          "$(_dbml_symbol box.rounded.tr ╮)"
          "$(_dbml_symbol box.rounded.bl ╰)"
          "$(_dbml_symbol box.rounded.br ╯)"
          "$(_dbml_symbol box.rounded.v │)"
          "$(_dbml_symbol box.rounded.h ─)"
        ) ;;
      *)
        out=("+" "+" "+" "+" "|" "-") ;;
    esac
  else
    out=("+" "+" "+" "+" "|" "-")
  fi
}

# Draw box
_draw_box_render() {
  local style="$1" width="$2" pad="$3" title="$4"
  local content; content=$(cat)

  local cs; _dbml_charset "$style" cs
  local tl="${cs[0]}" tr="${cs[1]}" bl="${cs[2]}" br="${cs[3]}" v="${cs[4]}" h="${cs[5]}"

  local IFS=$'\n' lines=()
  while read -r l; do lines+=("$l"); done <<< "$content"

  local inner=$((width - 2 - pad*2))
  (( inner < 1 )) && inner=1

  # Top
  if [[ -n "$title" ]]; then
    local tit=" $title "
    (( ${#tit} > inner )) && tit=${tit:0:inner}
    local left=$(( (inner - ${#tit}) / 2 ))
    local right=$(( inner - ${#tit} - left ))
    printf "%s" "$tl"
    printf '%*s' "$pad" ''
    printf '%s' "$(printf '%*s' $left '' | tr ' ' "$h")"
    printf "%s" "$tit"
    printf '%s' "$(printf '%*s' $right '' | tr ' ' "$h")"
    printf '%*s' "$pad" ''
    printf "%s\n" "$tr"
  else
    printf "%s" "$tl"; printf '%*s' "$pad" ''
    printf '%*s' "$inner" '' | tr ' ' "$h"
    printf '%*s' "$pad" ''; printf "%s\n" "$tr"
  fi

  # Body
  for ln in "${lines[@]}"; do
    (( ${#ln} > inner )) && ln=${ln:0:inner}
    local rightpad=$(( inner - ${#ln} ))
    printf "%s" "$v"
    printf '%*s' "$pad" ''; printf "%s" "$ln"
    printf '%*s' "$rightpad" ''; printf '%*s' "$pad" ''
    printf "%s\n" "$v"
  done

  # Bottom
  printf "%s" "$bl"; printf '%*s' "$pad" ''
  printf '%*s' "$inner" '' | tr ' ' "$h"
  printf '%*s' "$pad" ''; printf "%s\n" "$br"
}

draw_box() {
  local style="$1" width="$2" pad="$3" title="$4"; shift 4
  local content="$*"
  [[ -z "$content" ]] && _draw_box_render "$style" "$width" "$pad" "$title" \
    || printf "%s" "$content" | _draw_box_render "$style" "$width" "$pad" "$title"
}

# Pulse effect (unchanged)
dbml_pulse() {
  local var_prefix="$1" delay="${2:-0.06}" iterations="${3:-30}"
  if ! (declare -p "${var_prefix}_1" >/dev/null 2>&1); then
    for ((i=0;i<iterations;i++)); do
      (( i % 2 == 0 )) && tput bold || tput sgr0
      sleep "$delay"
    done
    tput sgr0; return 0
  fi
  local colors=() idx=1
  while declare -p "${var_prefix}_${idx}" >/dev/null 2>&1; do
    colors+=("${!var_prefix}_${idx}") ; ((idx++))
  done
  for ((i=0;i<iterations;i++)); do
    local cidx=$(( i % ${#colors[@]} ))
    printf "%b" "${colors[$cidx]}"; sleep "$delay"
  done
  printf "%b" "${CML_RESET:-\e[0m}"
}

# Loaders
dbml_use_cml() {
  local cml_path="$1"
  [[ -f "$cml_path" ]] && source "$cml_path" && DBML_CML_LOADED=1
}

export -f draw_box dbml_pulse dbml_use_cml dbml_use_csml
export DBML_VERSION
